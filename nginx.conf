# Auto-detect available CPUs for optimal performance
worker_processes auto;
worker_rlimit_nofile 65535;

events {
    worker_connections 4096;
    multi_accept on;
    use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Buffer optimization
    client_body_buffer_size 10K;
    client_header_buffer_size 1k;
    client_max_body_size 100m;
    large_client_header_buffers 4 16k;

    # Enable sendfile for better performance
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 30;
    keepalive_requests 1000;

    # Timeouts
    client_body_timeout 12;
    client_header_timeout 12;
    send_timeout 10;

    # Open file cache
    open_file_cache max=10000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml application/javascript application/json image/svg+xml;
    gzip_comp_level 6;

    # ===========================================
    # ROOT/WWW DOMAIN - Landing Page Only
    # Serves: canaisdarks.com.br & www.canaisdarks.com.br
    # ===========================================
    server {
        listen 80;
        server_name www.canaisdarks.com.br canaisdarks.com.br;
        root /usr/share/nginx/html;
        index index.html;

        # Security headers for landing
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # Root redirects to /landing
        location = / {
            return 302 /landing;
        }

        # If someone hits the app HTML entrypoint on the root domain, always send to app.
        # This avoids the browser loading the dashboard from canaisdarks.com.br and then calling /api/* on the wrong host.
        location = /dashboard.html {
            return 308 https://app.canaisdarks.com.br$request_uri;
        }

        # Landing page - SPA fallback
        location /landing {
            try_files $uri $uri/ /index.html;
            
            # No cache for HTML (always get fresh content)
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }

        # Public pages (auth, terms, privacy, reset-password)
        location ~ ^/(auth|terms|privacy|reset-password|maintenance)$ {
            try_files $uri $uri/ /index.html;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }

        # Redirect ALL protected/app routes to app subdomain
        # This list must match APP_ROUTES in src/hooks/useAppDomainRedirect.ts
        location ~ ^/(dashboard|analyzer|history|explore|folders|channels|analytics|library|agents|prompts|voice|video-gen|youtube|search-channels|channel-analyzer|srt|settings|admin|scenes|plans|payment-success|pending-approval)(/.*)?$ {
            return 308 https://app.canaisdarks.com.br$request_uri;
        }

        # Redirect API calls to app subdomain
        location ^~ /api/ {
            return 308 https://app.canaisdarks.com.br$request_uri;
        }

        # Static assets - aggressive caching
        location ~* \.(js|css|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header X-Content-Type-Options "nosniff" always;
            try_files $uri =404;
        }

        # Images - moderate caching
        location ~* \.(png|jpg|jpeg|gif|ico|svg|webp)$ {
            expires 30d;
            add_header Cache-Control "public";
            add_header X-Content-Type-Options "nosniff" always;
            try_files $uri =404;
        }

        # Manifest and service worker - no cache
        location ~* (manifest\.json|sw\.js)$ {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            try_files $uri =404;
        }

        # Robots and sitemap
        location = /robots.txt {
            try_files $uri =404;
            add_header Cache-Control "public, max-age=86400";
        }

        location = /sitemap.xml {
            try_files $uri =404;
            add_header Cache-Control "public, max-age=86400";
        }

        # Health check
        location = /health {
            access_log off;
            return 200 "OK";
            add_header Content-Type text/plain;
        }

        # Fallback for other routes
        location / {
            try_files $uri $uri/ /index.html;
        }
    }

    # ===========================================
    # APP SUBDOMAIN - Full Application
    # Serves: app.canaisdarks.com.br
    # ===========================================
    server {
        listen 80;
        server_name app.canaisdarks.com.br;
        root /usr/share/nginx/html;
        index index.html;

        # Security headers for app
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;

        # Root serves the app directly
        location = / {
            try_files /index.html =404;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }

        # HTML should not be cached
        location ~* \.html$ {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }

        # Ensure /api/* never falls back to SPA HTML (prevents black-screen from JSON parsing HTML)
        location ^~ /api/ {
            default_type application/json;

            # Preflight support (some browsers/extensions will send OPTIONS)
            add_header Access-Control-Allow-Origin $http_origin always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "authorization, content-type, apikey, x-client-info" always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Vary "Origin" always;

            if ($request_method = OPTIONS) {
                return 204;
            }

            return 404 '{"error":"not_found","message":"API route not configured"}';
        }

        # All app routes - SPA fallback
        location / {
            try_files $uri $uri/ /index.html;
        }


        # Static assets - aggressive caching with versioning
        location ~* \.(js|css|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header X-Content-Type-Options "nosniff" always;
            try_files $uri =404;
        }

        # Images - moderate caching
        location ~* \.(png|jpg|jpeg|gif|ico|svg|webp)$ {
            expires 30d;
            add_header Cache-Control "public";
            add_header X-Content-Type-Options "nosniff" always;
            try_files $uri =404;
        }

        # Manifest and service worker - minimal cache
        location ~* (manifest\.json|sw\.js)$ {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            try_files $uri =404;
        }

        # Health check
        location = /health {
            access_log off;
            return 200 "OK";
            add_header Content-Type text/plain;
        }
    }
}