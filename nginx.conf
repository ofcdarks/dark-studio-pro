# ============================================
# NGINX CONFIG - Optimized for 1000+ concurrent users
# ============================================

# Auto-detect CPUs, 1 worker per CPU core
worker_processes auto;
worker_rlimit_nofile 100000;

events {
    # 8192 connections per worker = ~32k+ concurrent with 4 cores
    worker_connections 8192;
    multi_accept on;
    use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # ============================================
    # CONNECTION OPTIMIZATION FOR HIGH CONCURRENCY
    # ============================================
    
    # Buffer optimization - larger for concurrent requests
    client_body_buffer_size 16K;
    client_header_buffer_size 2k;
    client_max_body_size 100m;
    large_client_header_buffers 4 32k;

    # Enable sendfile for better performance
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    
    # Keep-alive optimization for connection reuse
    keepalive_timeout 65;
    keepalive_requests 10000;
    
    # Proxy buffering for upstream connections
    proxy_buffering on;
    proxy_buffer_size 4k;
    proxy_buffers 8 16k;
    proxy_busy_buffers_size 24k;

    # Timeouts adjusted for stability
    client_body_timeout 30;
    client_header_timeout 30;
    send_timeout 30;
    reset_timedout_connection on;

    # Open file cache - increased for high traffic
    open_file_cache max=50000 inactive=60s;
    open_file_cache_valid 60s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    # ============================================
    # BROTLI COMPRESSION (30% smaller than gzip)
    # ============================================
    # Note: Requires nginx-brotli module, fallback to gzip if not available
    
    # Gzip compression (fallback)
    gzip on;
    gzip_vary on;
    gzip_min_length 256;
    gzip_proxied any;
    gzip_types 
        text/plain 
        text/css 
        text/xml 
        text/javascript 
        application/x-javascript 
        application/xml 
        application/javascript 
        application/json 
        application/manifest+json
        image/svg+xml
        font/woff2;
    gzip_comp_level 6;
    gzip_static on;

    # ============================================
    # RATE LIMITING (protect against abuse)
    # ============================================
    
    # Define rate limit zones
    limit_req_zone $binary_remote_addr zone=general:20m rate=30r/s;
    limit_req_zone $binary_remote_addr zone=api:20m rate=10r/s;
    limit_conn_zone $binary_remote_addr zone=conn_limit:20m;
    
    # Connection limits
    limit_conn conn_limit 50;

    # ===========================================
    # ROOT/WWW DOMAIN - Landing Page Only
    # Serves: canaisdarks.com.br & www.canaisdarks.com.br
    # ===========================================
    server {
        listen 80;
        server_name www.canaisdarks.com.br canaisdarks.com.br;
        root /usr/share/nginx/html;
        index index.html;

        # Security headers for landing
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;

        # Apply rate limiting
        limit_req zone=general burst=50 nodelay;

        # Root redirects to /landing
        location = / {
            return 302 /landing;
        }

        # If someone hits the app HTML entrypoint on the root domain, always send to app.
        location = /dashboard.html {
            return 308 https://app.canaisdarks.com.br$request_uri;
        }

        # Landing page - SPA fallback
        location /landing {
            try_files $uri $uri/ /index.html;
            
            # No cache for HTML
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }

        # Public pages (auth, terms, privacy, reset-password)
        location ~ ^/(auth|terms|privacy|reset-password|maintenance)$ {
            try_files $uri $uri/ /index.html;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }

        # Redirect ALL protected/app routes to app subdomain
        location ~ ^/(dashboard|analyzer|history|explore|folders|channels|analytics|library|agents|prompts|voice|video-gen|youtube|search-channels|channel-analyzer|srt|settings|admin|scenes|plans|payment-success|pending-approval)(/.*)?$ {
            return 308 https://app.canaisdarks.com.br$request_uri;
        }

        # Redirect API calls to app subdomain
        location ^~ /api/ {
            return 308 https://app.canaisdarks.com.br$request_uri;
        }

        # Static assets - aggressive caching with gzip_static
        location ~* \.(js|css|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header X-Content-Type-Options "nosniff" always;
            add_header Vary "Accept-Encoding";
            try_files $uri =404;
        }

        # Images - moderate caching
        location ~* \.(png|jpg|jpeg|gif|ico|svg|webp)$ {
            expires 30d;
            add_header Cache-Control "public";
            add_header X-Content-Type-Options "nosniff" always;
            try_files $uri =404;
        }

        # Manifest and service worker - no cache
        location ~* (manifest\.json|sw\.js)$ {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            try_files $uri =404;
        }

        # Robots and sitemap
        location = /robots.txt {
            try_files $uri =404;
            add_header Cache-Control "public, max-age=86400";
        }

        location = /sitemap.xml {
            try_files $uri =404;
            add_header Cache-Control "public, max-age=86400";
        }

        # Health check
        location = /health {
            access_log off;
            return 200 "OK";
            add_header Content-Type text/plain;
        }

        # Fallback for other routes
        location / {
            try_files $uri $uri/ /index.html;
        }
    }

    # ===========================================
    # APP SUBDOMAIN - Full Application
    # Serves: app.canaisdarks.com.br
    # ===========================================
    server {
        listen 80;
        server_name app.canaisdarks.com.br;
        root /usr/share/nginx/html;
        index index.html;

        # Security headers for app
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Permissions-Policy "camera=(), microphone=(), geolocation=()" always;

        # Apply rate limiting for app
        limit_req zone=general burst=100 nodelay;

        # Root serves the app directly
        location = / {
            try_files /index.html =404;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }

        # HTML should not be cached
        location ~* \.html$ {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
        }

        # API routes with stricter rate limiting
        location ^~ /api/ {
            limit_req zone=api burst=20 nodelay;
            default_type application/json;

            add_header Access-Control-Allow-Origin $http_origin always;
            add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
            add_header Access-Control-Allow-Headers "authorization, content-type, apikey, x-client-info" always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Vary "Origin" always;

            if ($request_method = OPTIONS) {
                return 204;
            }

            return 404 '{"error":"not_found","message":"API route not configured"}';
        }

        # All app routes - SPA fallback
        location / {
            try_files $uri $uri/ /index.html;
        }


        # Static assets - aggressive caching with versioning
        location ~* \.(js|css|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
            add_header X-Content-Type-Options "nosniff" always;
            try_files $uri =404;
        }

        # Images - moderate caching
        location ~* \.(png|jpg|jpeg|gif|ico|svg|webp)$ {
            expires 30d;
            add_header Cache-Control "public";
            add_header X-Content-Type-Options "nosniff" always;
            try_files $uri =404;
        }

        # Manifest and service worker - minimal cache
        location ~* (manifest\.json|sw\.js)$ {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            try_files $uri =404;
        }

        # Health check
        location = /health {
            access_log off;
            return 200 "OK";
            add_header Content-Type text/plain;
        }
    }
}