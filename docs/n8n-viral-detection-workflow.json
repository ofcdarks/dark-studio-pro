{
  "name": "üî• Detec√ß√£o de V√≠deos Virais v9 (Filtro Pa√≠s + Shorts)",
  "nodes": [
    {
      "parameters": {
        "rule": { "interval": [{ "field": "hours", "hoursInterval": 1 }] }
      },
      "id": "schedule-trigger",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [-240, 300],
      "notes": "Executa a cada 1 hora"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://kabnbvnephjifeazaiis.supabase.co/functions/v1/get-viral-monitoring-configs",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImthYm5idm5lcGhqaWZlYXphaWlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxNDU0ODksImV4cCI6MjA4MjcyMTQ4OX0.usAoqnQCFqrxCujKBqrBTmxp_MmVY-w_LhzKAa7Nm5I"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImthYm5idm5lcGhqaWZlYXphaWlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxNDU0ODksImV4cCI6MjA4MjcyMTQ4OX0.usAoqnQCFqrxCujKBqrBTmxp_MmVY-w_LhzKAa7Nm5I"
            }
          ]
        },
        "options": {}
      },
      "id": "fetch-configs",
      "name": "Fetch User Configs",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [0, 300],
      "notes": "Busca todas as configs de monitoramento viral ativas"
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\n\nif (!response.success || !response.configs || response.configs.length === 0) {\n  return [{ json: { hasConfigs: false, message: 'No active configs found' } }];\n}\n\nreturn response.configs.map(config => ({\n  json: {\n    hasConfigs: true,\n    user_id: config.user_id,\n    niches: config.niches,\n    viral_threshold: config.viral_threshold,\n    youtube_api_key: config.youtube_api_key,\n    country: config.country || 'US',\n    video_types: config.video_types || ['long', 'short']\n  }\n}));"
      },
      "id": "prepare-configs",
      "name": "Prepare Configs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [220, 300],
      "notes": "Prepara configs para processamento em loop"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [{ "value1": "={{ $json.hasConfigs }}", "value2": true }]
        }
      },
      "id": "has-configs",
      "name": "Has Configs?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [440, 300]
    },
    {
      "parameters": {
        "jsCode": "const item = $input.first().json;\nconst niches = item.niches;\nconst youtubeApiKey = item.youtube_api_key;\nconst userId = item.user_id;\nconst viralThreshold = item.viral_threshold || 1000;\nconst videoTypes = item.video_types || ['long'];\nconst country = item.country || 'US';\n\nconst publishedAfter = new Date();\npublishedAfter.setDate(publishedAfter.getDate() - 7);\nconst publishedAfterISO = publishedAfter.toISOString();\n\n// Determine video duration filter based on user preference\nlet videoDurationFilter = '';\nif (videoTypes.includes('long') && videoTypes.includes('short')) {\n  videoDurationFilter = '';\n} else if (videoTypes.includes('long')) {\n  videoDurationFilter = '&videoDuration=medium';\n} else if (videoTypes.includes('short')) {\n  videoDurationFilter = '&videoDuration=short';\n}\n\n// Build search URL with regionCode and relevanceLanguage\nconst searchUrls = niches.map(niche => ({\n  niche: niche,\n  url: `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&order=viewCount&maxResults=25&publishedAfter=${publishedAfterISO}${videoDurationFilter}&regionCode=${country}&relevanceLanguage=${country === 'BR' ? 'pt' : country === 'ES' ? 'es' : country === 'US' ? 'en' : 'en'}&q=${encodeURIComponent(niche)}&key=${youtubeApiKey}`\n}));\n\nreturn searchUrls.map(item => ({\n  json: {\n    user_id: userId,\n    viral_threshold: viralThreshold,\n    youtube_api_key: youtubeApiKey,\n    video_types: videoTypes,\n    country: country,\n    niche: item.niche,\n    searchUrl: item.url\n  }\n}));"
      },
      "id": "prepare-searches",
      "name": "Prepare Search URLs",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [660, 200],
      "notes": "Gera URL de busca com regionCode e relevanceLanguage do pa√≠s do usu√°rio"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $json.searchUrl }}",
        "options": {
          "response": {
            "response": {
              "fullResponse": false
            }
          }
        }
      },
      "id": "search-youtube",
      "name": "Search YouTube",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [880, 200],
      "notes": "Busca v√≠deos no YouTube para o nicho",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// CORRE√á√ÉO v8: Passa video_types para o pr√≥ximo n√≥\nconst currentItem = $input.first();\nconst searchResult = currentItem.json;\n\n// Buscar metadados do item correspondente usando $itemIndex\nconst itemIndex = typeof $itemIndex !== 'undefined' ? $itemIndex : 0;\nconst allPreparedItems = $('Prepare Search URLs').all();\nconst prevData = allPreparedItems[itemIndex]?.json || allPreparedItems[0]?.json;\n\nif (!searchResult.items || searchResult.items.length === 0) {\n  return [{ \n    json: { \n      hasVideos: false, \n      user_id: prevData.user_id, \n      niche: prevData.niche,\n      error: searchResult.error?.message || 'No videos found'\n    } \n  }];\n}\n\nconst videoIds = searchResult.items.map(item => item.id.videoId).filter(id => id).join(',');\n\nif (!videoIds) {\n  return [{ \n    json: { \n      hasVideos: false, \n      user_id: prevData.user_id, \n      niche: prevData.niche,\n      error: 'No valid video IDs found'\n    } \n  }];\n}\n\nconst statsUrl = `https://www.googleapis.com/youtube/v3/videos?part=statistics,snippet&id=${videoIds}&key=${prevData.youtube_api_key}`;\n\nreturn [{\n  json: {\n    hasVideos: true,\n    user_id: prevData.user_id,\n    niche: prevData.niche,\n    viral_threshold: prevData.viral_threshold,\n    youtube_api_key: prevData.youtube_api_key,\n    video_types: prevData.video_types || ['long'],\n    videos: searchResult.items,\n    statsUrl: statsUrl\n  }\n}];"
      },
      "id": "parse-search",
      "name": "Parse Search Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 200],
      "notes": "CORRIGIDO v8: Passa video_types para filtrar Shorts"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [{ "value1": "={{ $json.hasVideos }}", "value2": true }]
        }
      },
      "id": "has-videos",
      "name": "Has Videos?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1320, 200]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $json.statsUrl }}",
        "options": {
          "response": {
            "response": {
              "fullResponse": false
            }
          }
        }
      },
      "id": "get-stats",
      "name": "Get Video Statistics",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1540, 100],
      "notes": "Busca estat√≠sticas dos v√≠deos encontrados",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// CORRE√á√ÉO v8: Filtro de Shorts baseado em video_types\nconst currentItem = $input.first();\nconst statsResult = currentItem.json;\n\n// Buscar metadados do item correspondente usando $itemIndex\nconst itemIndex = typeof $itemIndex !== 'undefined' ? $itemIndex : 0;\nconst allParsedItems = $('Parse Search Results').all();\nconst prevData = allParsedItems[itemIndex]?.json || allParsedItems[0]?.json;\n\nconst viralThreshold = prevData.viral_threshold || 1000;\nconst videoTypes = prevData.video_types || ['long'];\nconst wantsShorts = videoTypes.includes('short');\nconst wantsLong = videoTypes.includes('long');\n\n// Verificar se temos resultados v√°lidos\nif (!statsResult.items || statsResult.items.length === 0) {\n  return [{ \n    json: { \n      hasVirals: false, \n      user_id: prevData.user_id, \n      niche: prevData.niche,\n      error: statsResult.error?.message || 'No stats found'\n    } \n  }];\n}\n\n// Fun√ß√£o para detectar se √© um Short\nconst isShort = (title, description = '') => {\n  const text = (title + ' ' + description).toLowerCase();\n  return text.includes('#shorts') || text.includes('#short') || text.includes('#shortsfeed');\n};\n\nconst viralVideos = statsResult.items\n  .filter(video => {\n    // Filtrar baseado nas prefer√™ncias do usu√°rio\n    const videoIsShort = isShort(video.snippet?.title || '', video.snippet?.description || '');\n    \n    if (wantsShorts && wantsLong) return true; // Aceita tudo\n    if (wantsShorts && !wantsLong) return videoIsShort; // S√≥ shorts\n    if (wantsLong && !wantsShorts) return !videoIsShort; // S√≥ long (exclui shorts)\n    return true;\n  })\n  .map(video => {\n    const views = parseInt(video.statistics?.viewCount || '0');\n    const likes = parseInt(video.statistics?.likeCount || '0');\n    const comments = parseInt(video.statistics?.commentCount || '0');\n    const publishedAt = new Date(video.snippet?.publishedAt);\n    const hoursAgo = (Date.now() - publishedAt.getTime()) / (1000 * 60 * 60);\n    const viewsPerHour = hoursAgo > 0 ? views / hoursAgo : 0;\n    const videoIsShort = isShort(video.snippet?.title || '', video.snippet?.description || '');\n    \n    return {\n      video_id: video.id,\n      title: video.snippet?.title || 'Untitled',\n      channel_name: video.snippet?.channelTitle || 'Unknown',\n      channel_url: 'https://www.youtube.com/channel/' + (video.snippet?.channelId || ''),\n      video_url: 'https://www.youtube.com/watch?v=' + video.id,\n      thumbnail_url: video.snippet?.thumbnails?.high?.url || video.snippet?.thumbnails?.default?.url || '',\n      views: views,\n      likes: likes,\n      comments: comments,\n      published_at: video.snippet?.publishedAt,\n      viral_score: Math.round(viewsPerHour),\n      niche: prevData.niche,\n      hours_ago: Math.round(hoursAgo),\n      is_short: videoIsShort\n    };\n  })\n  .filter(video => video.viral_score >= viralThreshold)\n  .sort((a, b) => b.viral_score - a.viral_score)\n  .slice(0, 5);\n\nif (viralVideos.length === 0) {\n  return [{ \n    json: { \n      hasVirals: false, \n      user_id: prevData.user_id, \n      niche: prevData.niche,\n      message: `No videos above threshold (${viralThreshold} views/hour)`,\n      filtered_by: videoTypes.join(', ')\n    } \n  }];\n}\n\nreturn [{\n  json: {\n    hasVirals: true,\n    user_id: prevData.user_id,\n    niche: prevData.niche,\n    viralVideos: viralVideos,\n    count: viralVideos.length\n  }\n}];"
      },
      "id": "calculate-viral",
      "name": "Calculate Viral Score",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1760, 100],
      "notes": "CORRIGIDO v8: Filtra Shorts baseado em video_types do usu√°rio"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [{ "value1": "={{ $json.hasVirals }}", "value2": true }]
        }
      },
      "id": "has-virals",
      "name": "Has Virals?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1980, 100]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://kabnbvnephjifeazaiis.supabase.co/functions/v1/viral-webhook",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImthYm5idm5lcGhqaWZlYXphaWlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxNDU0ODksImV4cCI6MjA4MjcyMTQ4OX0.usAoqnQCFqrxCujKBqrBTmxp_MmVY-w_LhzKAa7Nm5I"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImthYm5idm5lcGhqaWZlYXphaWlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxNDU0ODksImV4cCI6MjA4MjcyMTQ4OX0.usAoqnQCFqrxCujKBqrBTmxp_MmVY-w_LhzKAa7Nm5I"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ user_id: $json.user_id, videos: $json.viralVideos }) }}",
        "options": {}
      },
      "id": "send-webhook",
      "name": "Send to Viral Webhook",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2200, 0],
      "notes": "Envia v√≠deos virais para o sistema"
    },
    {
      "parameters": {},
      "id": "no-configs",
      "name": "No Active Configs",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [660, 400]
    },
    {
      "parameters": {},
      "id": "no-videos",
      "name": "No Videos Found",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1540, 300]
    },
    {
      "parameters": {},
      "id": "no-virals",
      "name": "No Viral Videos",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [2200, 200]
    }
  ],
  "connections": {
    "Schedule Trigger": { "main": [[{ "node": "Fetch User Configs", "type": "main", "index": 0 }]] },
    "Fetch User Configs": { "main": [[{ "node": "Prepare Configs", "type": "main", "index": 0 }]] },
    "Prepare Configs": { "main": [[{ "node": "Has Configs?", "type": "main", "index": 0 }]] },
    "Has Configs?": {
      "main": [
        [{ "node": "Prepare Search URLs", "type": "main", "index": 0 }],
        [{ "node": "No Active Configs", "type": "main", "index": 0 }]
      ]
    },
    "Prepare Search URLs": { "main": [[{ "node": "Search YouTube", "type": "main", "index": 0 }]] },
    "Search YouTube": { "main": [[{ "node": "Parse Search Results", "type": "main", "index": 0 }]] },
    "Parse Search Results": { "main": [[{ "node": "Has Videos?", "type": "main", "index": 0 }]] },
    "Has Videos?": {
      "main": [
        [{ "node": "Get Video Statistics", "type": "main", "index": 0 }],
        [{ "node": "No Videos Found", "type": "main", "index": 0 }]
      ]
    },
    "Get Video Statistics": { "main": [[{ "node": "Calculate Viral Score", "type": "main", "index": 0 }]] },
    "Calculate Viral Score": { "main": [[{ "node": "Has Virals?", "type": "main", "index": 0 }]] },
    "Has Virals?": {
      "main": [
        [{ "node": "Send to Viral Webhook", "type": "main", "index": 0 }],
        [{ "node": "No Viral Videos", "type": "main", "index": 0 }]
      ]
    }
  },
  "active": false,
  "settings": { "executionOrder": "v1" },
  "tags": ["viral", "youtube", "multi-user", "shorts-filter"],
  "meta": { "templateId": "viral-detection-v8-shorts-filter" }
}
